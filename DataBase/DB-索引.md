# DB-索引

[TOC]

## 1. 索引概念

**索引是一种用于==快速查询和检索==数据的数据结构。常见的索引结构有: B 树， B+树和 Hash。**

**优点**：

1. 加快数据的检索速度
2. 唯一索引可以保证表中每行数据的唯一性

**缺点：**

1. 创建索引和维护索引耗费时间（CRUD，索引也需要修改）
2. 索引占用存储空间

### 1.1 索引类型

#### 1.1.1 主键索引与辅助索引（二级索引）

**主索引：**一个表只有一个主键（不能为null），唯一。InnoDB的表，如果没有显示的指定表的主键，InnoDB会检查有没有唯一索引的字段，有则将其设置为默认主键，否则会自动创建新增的主键。

**二级索引：**

唯一索引：属性列的值不能重复，但可以为null，可以对多个字段建立唯一索引。

普通索引：加快查询速度，值可以重复可以为null。

前缀索引：字符串前几个字符。

#### 1.1.2 聚集索引与非聚集索引

**聚集索引（聚簇）：**数据行的物理顺序与列值的逻辑顺序相同，一个表中只能拥有一个聚集索引。 InnoDB 引擎中，表的索引(B+树)的每个非叶子节点存储索引，叶子节点存储索引和索引对应的数据。

**聚集优点：**查询速度快，B+树是平衡树，搜索到叶子结点即定位到数据。（叶子节点如何存储数据？）

**聚集缺点：**依赖有序数据。更新代价大：插入更新要调整树，慢。

**非聚集索引（非聚簇）：**索引的逻辑顺序与磁盘上行的物理存储顺序不同，一个表中可以拥有多个非聚集索引。非聚集索引叶节点=键+书签（指针），指针指向对应的数据块。InnoDB中，书签是相应行数据的主键索引。

非聚集优点：更新代价小。

非聚集缺点：依赖有序数据。可能需要二次查询（回表）。

#### 1.1.3 覆盖索引

索引包含所有查询列。比如：

```sql
(name, age)是组会索引
select name, age from stu where name = "chan"; 
```

#### 1.1.4 稠密索引和稀疏索引



总结：

1. 聚集索引尽量建立在值不会发生变更的列上
2. 使用聚集索引的查询效率要比非聚集索引的效率要高，但是如果需要频繁去改变聚集索引的值，写入性能并不高，因为需要移动对应数据的物理位置。
3. 非聚集索引在查询的时候可以的话就避免二次查询，这样性能会大幅提升。
4. 不是所有的表都适合建立索引，只有数据量大表才适合建立索引，且建立在选择性高的列上面性能会更好。



## 2. B树和B+树

**B树和B+树的区别：**

1. B+树内节点不存储数据，所有 data 存储在叶节点导致查询时间复杂度固定为 log n。而B-树查询时间复杂度不固定，与 key 在树中的位置有关。
2. B+树叶节点两两相连可大大增加区间访问性，可使用在范围查询等，而B-树每个节点 key 和 data 在一起，则无法区间查找。
3. B+树更适合外部存储。由于内节点无 data 域，每个节点能索引的范围更大更精确。

## 3. 索引创建规则

### 3.1 何时创建/不创建索引

**何时创建索引**：

1. 表经常进行 SELECT 操作
2. 表很大，记录内容分布范围很广
3. 列名经常在 WHERE 子句或连接条件中出现

**何时不创建索引**：

1. 表经常进行 INSERT/UPDATE/DELETE 操作
2. 表很小
3. 列名不经常作为连接条件或出现在 WHERE 子句中

### 3.2 索引